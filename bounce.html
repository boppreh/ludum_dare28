<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='utf-8' />
    <head>
        <title>GL4</title>
    </head>

    <body style='background: black;'>
        <canvas id='canvas' width=800 height=600 style='display: block;
        background: #111; margin-left: auto; margin-right: auto; cursor: none;'></canvas>

        <script type='text/javascript' src='../gl4/gl4.js'></script>
        <script type='text/javascript' src='../gl4/behaviors.js'></script>
        <script type='text/javascript' src='../gl4/conditions.js'></script>
        <script type='text/javascript' src='../gl4/effects.js'></script>
        <script>
window.onclick = function() { gl4.isRunning() ? gl4.stop() : gl4.start(); }

function randCircle(center, radius) {
    var pos = {x: 0, y: 0};
    gl4.register(function () {
        var angle = Math.random() * Math.PI * 2;
        pos.x = center.x + Math.cos(angle) * radius;
        pos.y = center.y + Math.sin(angle) * radius;
    });
    return pos;
}

function Mission(nLives, successCondition, onSuccess, onFailure) {
    this.nLives = nLives;
    this.successCondition = successCondition || function () { return false; };
    this.onSuccess = onSuccess || function () {};
    this.onFailure = onFailure || function () {};
}

Mission.prototype.start = function () {
    var lives = gl4.createText(this.nLives, 'lives', {x: 0, y: 60}, {}, {},
                               {'textAlign': 'left', 'font': '72px Impact',
                                'fillStyle': 'red'});
    var points = gl4.createText(0, 'points', {x: 0, y: 60 + 72}, {}, {},
                                {'textAlign': 'left', 'font': '72px Impact',
                                 'fillStyle': 'green'});

    var player = gl4.createImg('player.png', 'player'); 
    push('player', {angle: 0.01})
    player.effects.push(shadow(8, 8, 2));
    var ball = gl4.createImg('ball.png', 'ball', {}, {}, {x: 0.01, y: 0.01, angle: 0}); 
    ball.effects.push(glow('blue', 10));
    var target = gl4.createImg('target.png', 'target'); 

    moveTo('player', 'mouse');
    on(or(mouseDown(), keyDown('space')),
       attract('ball', 'mouse', 2, 20));
    reflect('ball');

    on(pulse(), create('enemy.png', 'enemy', randCircle(gl4.screen.pos, 400)));
    on(hit('ball', 'enemy'),
       slowDown(MATCH_1, {x: 0.7, y: 0.7}),
       destroy(MATCH_2),
       points.increment);

    follow('enemy', 'target', 2);

    gl4.register('enemy', function(enemy) {
        // Make enemy face destination.
        enemy.pos.angle = Math.atan2(-enemy.inertia.y, enemy.inertia.x);
    });
    on(hit('enemy', 'target'),
       destroy(MATCH_1),
       lives.decrement);

    on(this.successCondition,
       this.onSuccess);

    on(lives.isZero,
       this.onFailure);
};

Mission.prototype.stop = function () {
    gl4.clear();
};


var mission = new Mission(10);
mission.start();
gl4.start(true);
        </script>
    </body>
</html>
