<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <title>GL4</title>
    </head>

    <body style='background: black;'>
        <canvas id='canvas' width=800 height=600 style='display: block;
        background: #111; margin-left: auto; margin-right: auto; cursor: none;'></canvas>

        <script type='text/javascript' src='../gl4/gl4.js'></script>
        <script type='text/javascript' src='../gl4/behaviors.js'></script>
        <script type='text/javascript' src='../gl4/conditions.js'></script>
        <script>
function makeCursor() {
    var player = gl4.createImage('player.png', 'player'); 
    moveTo('player', gl4.mouse);
    shadow('idle attractor', 8, 8, 2);
    glow('attractor', '#66F', 20);
    push('idle attractor', {angle: 0.01})
    push('attractor', {angle: -0.1})
    on(or(mouseDown(), keyDown('space')),
       [tag('player', 'attractor'), untag('player', 'idle attractor')],
       [tag('player', 'idle attractor'), untag('player', 'attractor')]);
}

function mainMechanics(props) {
    props = fillDefault(props, {attackFrequency: 3});

    var ball = gl4.createImage('ball.png', 'ball', {}, {}, {},
                               {x: 0.01, y: 0.01, angle: 0}); 
    glow('ball', '#66F', 20);
    reflect('ball');

    var target = gl4.createImage('target.png', 'target'); 

    on(pulse(props.attackFrequency),
       create('enemy.png', 'enemy', randCircle(gl4.screen.pos, 400)));
    follow('enemy', 'target', 2);
    on(circleHit('enemy', 'target'),
       destroy());
    on(hit('ball', 'enemy'),
       [destroy(MATCH_2), attract(MATCH_1, MATCH_2, -5)]);

    gl4.register('enemy', function(enemy) {
        // Make enemy face destination.
        enemy.pos.angle = Math.atan2(-enemy.inertia.y, enemy.inertia.x);
    });
}

function startMission(props) {
    gl4.unlayerAll();

    var gameLayer = gl4.layer();

    makeCursor();

    var uiLayer = gl4.layer();
    var lives = gl4.createText(props.nLives, 'text', {x: 50, y: 60}, {}, {});
    lives.font = '72px Impact';
    lives.color = 'red';
    lives.alignment = 'left';
    lives.minValue = 0;
    var points = gl4.createText(0, 'text', {x: 50, y: 60 + 72}, {}, {});
    points.font = lives.font;
    points.color = 'green';
    points.alignment = 'left';
    points.minDigits = 5;
    shadow('text');
    gl4.layer(gameLayer);

    attract('ball', 'attractor', 2, 20);
    on(hit('enemy', 'target'),
       lives.subtract());
    on(hit('enemy', 'ball'),
       points.add(10));
    mainMechanics(props);

    on(props.successCondition || function () { return [] },
       props.onSuccess || function () {});
    on(lives.at(0),
       props.onFailure || function () {});
}

//gl4.debug = true;

function makeStartScreen() {
    gl4.unlayerAll();
    var lowerLayer = gl4.activeLayer;

    var topLayer = gl4.layer();
    makeCursor();
    gl4.layer(lowerLayer);

    var demoLayer = gl4.layer();
    mainMechanics({attackFrequency: 0.5});
    attract('ball', 'enemy', 0.05);
    gl4.forEach('ball', function (ball) {
        ball.push({x: Math.random() * 2 - 1, y: -Math.random() * 2});
    });

    var startScreen = gl4.layer();
    var title = gl4.createText('Game Title', ['screen text'], {y: 200});
    title.font = '126px Impact';

    var btnStart = gl4.createText('New Game', ['screen text', 'button'], {y: 400});
    btnStart.font = '62px Impact';
    //btnStart.

    shadow('screen text');
    gl4.forEach('screen text', function (t) {
        t.friction = {x: 0.01, y: 0.01, angle: 0.01};
        t.push({x: Math.random() * 0.2 - 0.1,
                y: Math.random() * 0.2 - 0.1,
                angle: Math.random() * 0.002 - 0.001})
    });

    on(click(btnStart), function () {
        startMission({nLives: 10, onFailure: makeStartScreen});
    });
}

makeStartScreen();
        </script>
    </body>
</html>
